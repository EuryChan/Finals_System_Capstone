{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Requirements Monitoring</title>
  <link rel="stylesheet" href="{% static 'CSS/requirements_monitoring.css' %}">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      min-height: 100vh;
    }
    

    /* ========== WELCOME PAGE ========== */
    .welcome-container {
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      padding: 20px;
      background-image: url("{% static 'Pictures/logo3.png' %}");
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
      position: relative;
    }

    .welcome-container::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0.3, 0.5);
      z-index: 1;
    }

    .welcome-card {
      background-color: #f7f9fc;
      border-radius: 20px;
      padding: 60px 50px;
      max-width: 700px;
      width: 100%;
      text-align: center;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      animation: fadeInUp 0.6s ease-out;
      position: relative;
      z-index: 2;
    }

    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .welcome-card h1 {
      font-size: 32px;
      color: #1a202c;
      margin-bottom: 20px;
      font-weight: 700;
    }

    .welcome-card p {
      font-size: 16px;
      color: #4a5568;
      line-height: 1.8;
      margin-bottom: 40px;
    }

    .get-started-btn {
      background: #007bff;
      color: white;
      border: none;
      padding: 16px 50px;
      font-size: 18px;
      font-weight: 600;
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.3s;
      box-shadow: 0 4px 15px rgba(0, 123, 255, 0.3);
    }

    .get-started-btn:hover {
      background: #0056b3;
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(0, 123, 255, 0.4);
    }

    /* ========== MAIN MONITORING CONTAINER ========== */
    .monitoring-container {
      display: none;
      min-height: 100vh;
      background: linear-gradient(to bottom, #f5f6fa, #0b1a50);
      color: #0b1a50;
    }

    .content {
      padding: 30px 50px;
      max-width: 1400px;
      margin: 0 auto;
    }

    .logo {
      width: 100px;
      object-fit: contain;
    }

    .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .top-bar h1 {
      font-size: 28px;
      color: #1a202c;
      margin: 0;
    }

    .top-controls {
      display: flex;
      gap: 15px;
      align-items: center;
    }

    .back-button {
      background: #007bff;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      transition: all 0.3s;
      box-shadow: 0 2px 8px rgba(0, 123, 255, 0.3);
    }

    .back-button:hover {
      background: #0056b3;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 123, 255, 0.4);
    }

    .user-icon {
      width: 45px;
      height: 45px;
      background: #1a202c;
      color: white;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      font-size: 18px;
      cursor: pointer;
      position: relative;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
      transition: all 0.3s;
    }

    .user-icon:hover {
      transform: scale(1.05);
    }

    .user-dropdown {
      position: absolute;
      top: 55px;
      right: 0;
      background: white;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      padding: 5px 0;
      min-width: 150px;
      display: none;
      z-index: 1000;
    }

    .user-dropdown.show {
      display: block;
    }

    .user-dropdown-item {
      padding: 10px 20px;
      cursor: pointer;
      transition: background 0.2s;
      font-size: 14px;
      color: #1a202c;
    }

    .user-dropdown-item:hover {
      background: #f3f4f6;
    }

    /* Notification Badge */
    .notification-badge {
      position: absolute;
      top: -5px;
      right: -5px;
      background: #ef4444;
      color: white;
      border-radius: 50%;
      min-width: 20px;
      height: 20px;
      font-size: 11px;
      font-weight: bold;
      display: none;
      align-items: center;
      justify-content: center;
      padding: 2px 6px;
      animation: pulse 2s infinite;
      z-index: 10;
      box-shadow: 0 2px 8px rgba(239, 68, 68, 0.4);
    }

    @keyframes pulse {
      0%, 100% {
        transform: scale(1);
        box-shadow: 0 2px 8px rgba(239, 68, 68, 0.4);
      }
      50% {
        transform: scale(1.1);
        box-shadow: 0 2px 12px rgba(239, 68, 68, 0.6);
      }
    }

    /* Barangay Notification Dropdown */
    .barangay-notification-dropdown {
      position: fixed;
      top: 80px;
      right: 80px;
      background: white;
      border-radius: 12px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.25);
      border: 1px solid #e5e7eb;
      width: 420px;
      max-height: 550px;
      display: none;
      z-index: 9999;
      overflow: hidden;
    }

    .barangay-notification-dropdown.show {
      display: block;
      animation: slideDown 0.3s ease-out;
    }

    @keyframes slideDown {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .notification-header {
      padding: 18px 20px;
      border-bottom: 2px solid #e5e7eb;
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: #f9fafb;
    }

    .notification-header h3 {
      font-size: 18px;
      color: #1a202c;
      margin: 0;
      font-weight: 700;
    }

    .mark-all-read {
      background: none;
      border: none;
      color: #007bff;
      font-size: 13px;
      cursor: pointer;
      padding: 5px 10px;
      border-radius: 4px;
      transition: all 0.2s;
      font-weight: 600;
    }

    .mark-all-read:hover {
      background: #e5e7eb;
    }

    .notification-list {
      max-height: 400px;
      overflow-y: auto;
    }

    .notification-list::-webkit-scrollbar {
      width: 6px;
    }

    .notification-list::-webkit-scrollbar-thumb {
      background: #d1d5db;
      border-radius: 3px;
    }

    .notification-empty {
      padding: 60px 20px;
      text-align: center;
      color: #9ca3af;
      background: white;
    }

    .notification-empty-icon {
      font-size: 64px;
      margin-bottom: 15px;
      opacity: 0.6;
    }

    .notification-empty p {
      font-size: 16px;
      color: #6b7280;
      font-weight: 500;
      margin: 0;
    }

    .notification-item {
      padding: 15px 20px;
      border-bottom: 1px solid #f3f4f6;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      gap: 12px;
      align-items: start;
    }

    .notification-item:hover {
      background: #f9fafb;
    }

    .notification-item.unread {
      background: #eff6ff;
    }

    .notification-icon {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      flex-shrink: 0;
    }

    .notification-icon.info {
      background: #dbeafe;
      color: #3b82f6;
    }

    .notification-icon.completed {
      background: #d1fae5;
      color: #10b981;
    }

    .notification-icon.overdue {
      background: #fee2e2;
      color: #ef4444;
    }

    .notification-icon.upcoming {
      background: #fef3c7;
      color: #f59e0b;
    }

    .notification-content {
      flex: 1;
      min-width: 0;
    }

    .notification-title {
      font-weight: 600;
      color: #1a202c;
      font-size: 14px;
      margin-bottom: 4px;
    }

    .notification-message {
      color: #6b7280;
      font-size: 13px;
      line-height: 1.4;
      margin-bottom: 4px;
    }

    .notification-time {
      color: #9ca3af;
      font-size: 12px;
    }

    /* Filter Tabs */
    .filter-tabs {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      padding: 20px;
    }

    .tab {
      padding: 10px 24px;
      border: 2px solid #e5e7eb;
      background: white;
      border-radius: 25px;
      cursor: pointer;
      transition: all 0.3s;
      font-size: 14px;
      font-weight: 600;
      color: #4a5568;
    }

    .tab:hover {
      border-color: #007bff;
      color: #007bff;
      transform: translateY(-2px);
    }

    .tab.active {
      background: #007bff;
      color: white;
      border-color: transparent;
      box-shadow: 0 4px 12px rgba(0, 123, 255, 0.3);
    }

    .search-box {
      padding: 10px 20px;
      border: 2px solid #e5e7eb;
      border-radius: 25px;
      margin-left: auto;
      width: 250px;
      font-size: 14px;
      transition: all 0.3s;
    }

    .search-box:focus {
      outline: none;
      border-color: #007bff;
      box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
    }

    /* Barangay Header */
    .barangay-header {
      display: flex;
      align-items: center;
      gap: 20px;
      border-radius: 15px;
    }

    .barangay-header h2 {
      font-size: 30px;
      color: #1a202c;
      font-weight: 700;
    }

    .date {
      color: #6b7280;
      font-size: 14px;
    }

    /* Task Card */
    .task-card {
      background: white;
      border-radius: 15px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      position: relative;
      margin-bottom: 15px;
      transition: all 0.3s;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 20px;
      margin-top: 20px;
    }

    .task-card:hover {
      box-shadow: 0 10px 20px rgba(0,0,0,0.15);
      transform: translateY(-3px);
    }

    .task-info {
      flex: 1;
      display: flex;
      align-items: center;
      gap: 20px;
    }

    .task-card h3 {
      font-size: 18px;
      color: #1a202c;
      margin: 0;
      font-weight: 600;
    }

    .status {
      margin: 0;
      font-size: 13px;
      font-weight: 700;
      padding: 8px 18px;
      border-radius: 20px;
      white-space: nowrap;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .status.accomplished {
      color: #059669;
      background: #d1fae5;
    }

    .status.in-progress, .status.in_progress {
      color: #d97706;
      background: #fef3c7;
    }

    .status.pending {
      color: #dc2626;
      background: #fee2e2;
    }

    .status.approved {
      color: #1e40af;
      background: #dbeafe;
    }

    .status.rejected {
      color: #991b1b;
      background: #fee2e2;
    }

    .card-actions {
      display: flex;
      gap: 10px;
    }

    .view-btn {
      padding: 12px 28px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.3s;
      font-weight: 600;
      white-space: nowrap;
      background: #007bff;
      color: white;
      box-shadow: 0 2px 8px rgba(0, 123, 255, 0.3);
    }

    .view-btn:hover {
      background: #0056b3;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 123, 255, 0.4);
    }

    /* Loading Spinner */
    .loading {
      text-align: center;
      padding: 60px 40px;
      font-size: 16px;
      color: #6b7280;
      background: white;
      border-radius: 15px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }

    .spinner {
      border: 4px solid #f3f4f6;
      border-top: 4px solid #007bff;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: spin 1s linear infinite;
      margin: 0 auto 15px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* ========== DETAIL PAGE ========== */
    .detail-container {
      display: none;
      min-height: 100vh;
      padding: 30px;
      background: linear-gradient(to bottom, #f5f6fa, #0b1a50);
      color: #0b1a50;
    }

    .detail-card {
      background: white;
      padding: 40px;
      border-radius: 15px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      max-width: 1200px;
      margin: 0 auto;
    }

    .detail-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
      padding-bottom: 20px;
      border-bottom: 2px solid #e5e7eb;
    }

    .detail-header h2 {
      font-size: 26px;
      color: #1a202c;
      font-weight: 700;
    }

    .update-btn {
      background: #007bff;
      color: white;
      border: none;
      padding: 12px 28px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      transition: all 0.3s;
      box-shadow: 0 2px 8px rgba(0, 123, 255, 0.3);
    }

    .update-btn:hover {
      background: #0056b3;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 123, 255, 0.4);
    }

    .detail-description {
      margin-bottom: 30px;
      color: #4a5568;
      line-height: 1.8;
      font-size: 15px;
    }

    .file-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 15px;
      background: #f9fafb;
      border-radius: 8px;
      margin-bottom: 10px;
      border: 1px solid #e5e7eb;
      transition: all 0.2s;
    }

    .file-item:hover {
      background: #f3f4f6;
      border-color: #d1d5db;
    }

    .file-item span {
      font-size: 14px;
      color: #1a202c;
    }

    .remove-file {
      background: #ef4444;
      color: white;
      border: none;
      padding: 6px 12px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 12px;
      font-weight: 600;
      transition: all 0.2s;
    }

    .remove-file:hover {
      background: #dc2626;
      transform: scale(1.05);
    }

    /* Toast Notification */
    .toast {
      position: fixed;
      bottom: 30px;
      right: 30px;
      background: #1a202c;
      color: white;
      padding: 16px 28px;
      border-radius: 10px;
      box-shadow: 0 8px 20px rgba(0,0,0,0.3);
      display: none;
      z-index: 2000;
      animation: slideIn 0.3s ease-out;
      font-weight: 600;
    }

    .toast.show {
      display: block;
    }

    .toast.success {
      background: #10b981;
    }

    .toast.error {
      background: #ef4444;
    }

    @keyframes slideIn {
      from {
        transform: translateX(400px);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    /* Professional Confirmation Modal */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.6);
      z-index: 3000;
      align-items: center;
      justify-content: center;
    }

    .modal-overlay.show {
      display: flex;
    }

    .modal-content {
      background: white;
      border-radius: 15px;
      padding: 35px;
      max-width: 420px;
      width: 90%;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      animation: modalSlideIn 0.3s ease-out;
    }

    @keyframes modalSlideIn {
      from {
        transform: translateY(-50px);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }

    .modal-title {
      font-size: 22px;
      font-weight: 700;
      color: #1a202c;
      margin-bottom: 12px;
    }

    .modal-message {
      font-size: 15px;
      color: #4a5568;
      line-height: 1.6;
      margin-bottom: 28px;
    }

    .modal-actions {
      display: flex;
      gap: 12px;
      justify-content: flex-end;
    }

    .modal-btn {
      padding: 11px 26px;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    .modal-btn-cancel {
      background: #e5e7eb;
      color: #1a202c;
    }

    .modal-btn-cancel:hover {
      background: #d1d5db;
    }

    .modal-btn-confirm {
      background: #007bff;
      color: white;
      box-shadow: 0 2px 8px rgba(0, 123, 255, 0.3);
    }

    .modal-btn-confirm:hover {
      background: #0056b3;
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(0, 123, 255, 0.4);
    }
    /* Professional Confirmation Modal */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.6);
      z-index: 3000;
      align-items: center;
      justify-content: center;
    }

    .modal-overlay.show {
      display: flex;
    }

    .modal-content {
      background: white;
      border-radius: 15px;
      padding: 35px;
      max-width: 420px;
      width: 90%;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      animation: modalSlideIn 0.3s ease-out;
    }

    /* Profile Modal Specific Styles */
    .profile-modal-content {
      max-width: 500px;
      padding: 0;
      overflow: hidden;
    }

    .profile-header {
      background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
      padding: 30px;
      text-align: center;
      color: white;
    }

    .profile-avatar {
      width: 100px;
      height: 100px;
      background: white;
      color: #007bff;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 40px;
      font-weight: bold;
      margin: 0 auto 15px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    }

    .profile-name {
      font-size: 24px;
      font-weight: 700;
      margin-bottom: 5px;
    }

    .profile-role {
      font-size: 14px;
      opacity: 0.9;
    }

    .profile-body {
      padding: 30px;
    }

    .profile-field {
      margin-bottom: 20px;
    }

    .profile-label {
      font-size: 12px;
      color: #6b7280;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      font-weight: 600;
      margin-bottom: 5px;
    }

    .profile-value {
      font-size: 16px;
      color: #1a202c;
      font-weight: 500;
    }

    .profile-footer {
      padding: 20px 30px;
      background: #f9fafb;
      border-top: 1px solid #e5e7eb;
      display: flex;
      justify-content: flex-end;
    }
    /* Settings Modal Styles */
    .settings-modal-content {
      max-width: 600px;
      padding: 0;
      overflow: hidden;
      max-height: 90vh;
      display: flex;
      flex-direction: column;
    }

    .settings-header {
      background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
      padding: 25px 30px;
      color: white;
    }

    .settings-title {
      font-size: 24px;
      font-weight: 700;
      margin: 0;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .settings-body {
      padding: 30px;
      overflow-y: auto;
      flex: 1;
    }

    .settings-body::-webkit-scrollbar {
      width: 6px;
    }

    .settings-body::-webkit-scrollbar-thumb {
      background: #d1d5db;
      border-radius: 3px;
    }

    .settings-section {
      margin-bottom: 30px;
      padding-bottom: 25px;
      border-bottom: 2px solid #e5e7eb;
    }

    .settings-section:last-child {
      border-bottom: none;
    }

    .settings-section-title {
      font-size: 16px;
      font-weight: 700;
      color: #1a202c;
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .settings-field {
      margin-bottom: 20px;
    }

    .settings-field:last-child {
      margin-bottom: 0;
    }

    .settings-label {
      display: block;
      font-size: 14px;
      font-weight: 600;
      color: #4a5568;
      margin-bottom: 8px;
    }

    .settings-input {
      width: 100%;
      padding: 10px 15px;
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      font-size: 14px;
      transition: all 0.3s;
    }

    .settings-input:focus {
      outline: none;
      border-color: #007bff;
      box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
    }

    .settings-toggle {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 0;
    }

    .settings-toggle-label {
      font-size: 14px;
      color: #1a202c;
      font-weight: 500;
    }

    .settings-toggle-description {
      font-size: 12px;
      color: #6b7280;
      margin-top: 2px;
    }

    .toggle-switch {
      position: relative;
      width: 48px;
      height: 24px;
      background: #d1d5db;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.3s;
    }

    .toggle-switch.active {
      background: #10b981;
    }

    .toggle-slider {
      position: absolute;
      top: 2px;
      left: 2px;
      width: 20px;
      height: 20px;
      background: white;
      border-radius: 50%;
      transition: all 0.3s;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }

    .toggle-switch.active .toggle-slider {
      transform: translateX(24px);
    }

    .settings-footer {
      padding: 20px 30px;
      background: #f9fafb;
      border-top: 1px solid #e5e7eb;
      display: flex;
      justify-content: space-between;
      gap: 10px;
    }

    .settings-btn {
      padding: 11px 26px;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    .settings-btn-cancel {
      background: #e5e7eb;
      color: #1a202c;
    }

    .settings-btn-cancel:hover {
      background: #d1d5db;
    }

    .settings-btn-save {
      background: #007bff;
      color: white;
      box-shadow: 0 2px 8px rgba(0, 123, 255, 0.3);
    }

    .settings-btn-save:hover {
      background: #0056b3;
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(0, 123, 255, 0.4);
    }

    .settings-help-text {
      font-size: 12px;
      color: #6b7280;
      margin-top: 5px;
    }

    /* Responsive Design */
    @media (max-width: 768px) {
      .content {
        padding: 20px;
      }

      .welcome-card {
        padding: 40px 30px;
      }

      .top-bar {
        flex-direction: column;
        gap: 15px;
        align-items: flex-start;
      }

      .filter-tabs {
        flex-direction: column;
      }

      .search-box {
        width: 100%;
        margin-left: 0;
      }

      .task-card {
        flex-direction: column;
        align-items: flex-start;
      }

      .card-actions {
        width: 100%;
      }

      .view-btn {
        width: 100%;
      }

      .barangay-notification-dropdown {
        right: 20px;
        left: 20px;
        width: auto;
      }
    }
  </style>
</head>
<body>
  <!-- Toast Notification -->
  <div class="toast" id="toast"></div>

  <!-- Barangay Notification Dropdown -->
  <div id="barangayNotificationDropdown" class="barangay-notification-dropdown">
    <div class="notification-header">
      <img src="{% static 'Pictures/icons/bell.png' %}" 
          alt="bell icon" 
          style="width: 20px; height: 20px; margin-right: 8px;">
      <h3>Notifications</h3>
      <button class="mark-all-read" onclick="markAllBarangayNotificationsRead()">Mark all as read</button>
    </div>
    <div class="notification-list" id="barangayNotificationList">
      <div class="notification-empty">
        <div class="notification-empty-icon"></div>
        <p>No notifications yet</p>
      </div>
    </div>
  </div>


  <!-- Professional Confirmation Modal -->
  <div class="modal-overlay" id="confirmModal">
    <div class="modal-content">
      <div class="modal-title" id="modalTitle">Confirm Action</div>
      <div class="modal-message" id="modalMessage">Are you sure you want to proceed?</div>
      <div class="modal-actions">
        <button class="modal-btn modal-btn-cancel" onclick="closeModal()">Cancel</button>
        <button class="modal-btn modal-btn-confirm" id="modalConfirmBtn">OK</button>
      </div>
    </div>
  </div>
  <!-- Profile Modal -->
  <div class="modal-overlay" id="profileModal">
    <div class="modal-content profile-modal-content">
      <div class="profile-header">
        <div class="profile-avatar" id="profileAvatar">U</div>
        <div class="profile-name" id="profileName">Loading...</div>
        <div class="profile-role" id="profileRole">Barangay User</div>
      </div>
      <div class="profile-body">
        <div class="profile-field">
          <div class="profile-label">üìß Email</div>
          <div class="profile-value" id="profileEmail">-</div>
        </div>
        <div class="profile-field">
          <div class="profile-label">üè¢ Barangay</div>
          <div class="profile-value" id="profileBarangay">-</div>
        </div>
        <div class="profile-field">
          <div class="profile-label">üë§ Username</div>
          <div class="profile-value" id="profileUsername">-</div>
        </div>
        <div class="profile-field">
          <div class="profile-label">üìÖ Member Since</div>
          <div class="profile-value" id="profileJoined">-</div>
        </div>
      </div>
      <div class="profile-footer">
        <button class="modal-btn modal-btn-cancel" onclick="closeProfileModal()">Close</button>
      </div>
    </div>
  </div>
  <!-- Settings Modal -->
  <div class="modal-overlay" id="settingsModal">
    <div class="modal-content settings-modal-content">
      <div class="settings-header">
        <h2 class="settings-title">‚öôÔ∏è Settings</h2>
      </div>
      
      <div class="settings-body">
        <!-- Account Settings -->
        <div class="settings-section">
          <div class="settings-section-title">üë§ Account Settings</div>
          
          <div class="settings-field">
            <label class="settings-label">Email Address</label>
            <input type="email" class="settings-input" id="settingsEmail" placeholder="your@email.com">
            <div class="settings-help-text">This email will be used for notifications and account recovery</div>
          </div>

          <div class="settings-field">
            <label class="settings-label">Current Password</label>
            <input type="password" class="settings-input" id="settingsCurrentPassword" placeholder="Enter current password">
          </div>

          <div class="settings-field">
            <label class="settings-label">New Password</label>
            <input type="password" class="settings-input" id="settingsNewPassword" placeholder="Enter new password">
            <div class="settings-help-text">Leave blank to keep current password</div>
          </div>

          <div class="settings-field">
            <label class="settings-label">Confirm New Password</label>
            <input type="password" class="settings-input" id="settingsConfirmPassword" placeholder="Confirm new password">
          </div>
        </div>

        <!-- Notification Settings -->
        <div class="settings-section">
          <div class="settings-section-title">üîî Notification Preferences</div>
          
          <div class="settings-toggle">
            <div>
              <div class="settings-toggle-label">Email Notifications</div>
              <div class="settings-toggle-description">Receive email updates for requirement deadlines</div>
            </div>
            <div class="toggle-switch" id="toggleEmailNotif" onclick="toggleSetting(this)">
              <div class="toggle-slider"></div>
            </div>
          </div>

          <div class="settings-toggle">
            <div>
              <div class="settings-toggle-label">Deadline Reminders</div>
              <div class="settings-toggle-description">Get reminded 24 hours before deadlines</div>
            </div>
            <div class="toggle-switch active" id="toggleDeadlineReminder" onclick="toggleSetting(this)">
              <div class="toggle-slider"></div>
            </div>
          </div>

          <div class="settings-toggle">
            <div>
              <div class="settings-toggle-label">Admin Announcements</div>
              <div class="settings-toggle-description">Receive notifications about system announcements</div>
            </div>
            <div class="toggle-switch active" id="toggleAnnouncements" onclick="toggleSetting(this)">
              <div class="toggle-slider"></div>
            </div>
          </div>
        </div>

        <!-- Display Settings -->
        <div class="settings-section">
          <div class="settings-section-title">üé® Display Settings</div>
          
          <div class="settings-toggle">
            <div>
              <div class="settings-toggle-label">Dark Mode</div>
              <div class="settings-toggle-description">Switch to dark theme (Coming Soon)</div>
            </div>
            <div class="toggle-switch" id="toggleDarkMode" onclick="toggleSetting(this)" style="opacity: 0.5; cursor: not-allowed;">
              <div class="toggle-slider"></div>
            </div>
          </div>

          <div class="settings-toggle">
            <div>
              <div class="settings-toggle-label">Compact View</div>
              <div class="settings-toggle-description">Show more items in less space</div>
            </div>
            <div class="toggle-switch" id="toggleCompactView" onclick="toggleSetting(this)">
              <div class="toggle-slider"></div>
            </div>
          </div>
        </div>
      </div>

      <div class="settings-footer">
        <button class="settings-btn settings-btn-cancel" onclick="closeSettingsModal()">Cancel</button>
        <button class="settings-btn settings-btn-save" onclick="saveSettings()">üíæ Save Changes</button>
      </div>
    </div>
  </div>

  <!-- ========== WELCOME PAGE ========== -->
  <div class="welcome-container" id="welcomePage">
    <div class="welcome-card">
      <h1>Requirements Monitoring System</h1>
      <p>Track and manage barangay requirements efficiently. Monitor weekly, monthly, quarterly, semestral, and annual compliance requirements in one centralized system.</p>
      <button class="get-started-btn" onclick="showMonitoring()">Get Started</button>
    </div>
  </div>

  <!-- ========== REQUIREMENTS LIST PAGE ========== -->
  <div class="monitoring-container" id="monitoringPage">
    <div class="content">
      <!-- Top Bar -->
      <div class="top-bar">
        <div style="display: flex; align-items: center; gap: 15px;">
          <img src="{% static 'Pictures/logo1.png' %}" alt="DILG Logo" class="logo">
          <div>
            <h1 style="margin: 0;">Requirements Monitoring</h1>
            <p style="margin: 5px 0 0 0; color: #6b7280; font-size: 14px;" id="topBarangayName">Loading...</p>
          </div>
        </div>
        
        <div class="top-controls">
          <button class="back-button" onclick="showWelcome()">‚Üê Back</button>
          <div style="position: relative;">
            <div class="user-icon" onclick="toggleNotificationDropdown(event)" style="background: #007bff; font-size: 22px;">
              <img src="{% static 'Pictures/icons/bell.png' %}" 
                  alt="bell icon" 
                  style="width: 22px; height: 22px;">
              <span id="barangayNotificationBadge" class="notification-badge">0</span>
            </div>
          </div>

          <div class="user-icon" onclick="toggleUserDropdown()">U
            <div class="user-dropdown" id="userDropdown">
              <div class="user-dropdown-item" onclick="viewProfile()">Profile</div>
              <div class="user-dropdown-item" onclick="viewSettings()">Settings</div>
              <div class="user-dropdown-item" onclick="logout()">Logout</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Filter Tabs -->
      <div class="filter-tabs">
        <button class="tab active" onclick="filterByPeriod(this, 'weekly')">Weekly</button>
        <button class="tab" onclick="filterByPeriod(this, 'monthly')">Monthly</button>
        <button class="tab" onclick="filterByPeriod(this, 'semestral')">Semestral</button>
        <button class="tab" onclick="filterByPeriod(this, 'quarterly')">Quarterly</button>
        <button class="tab" onclick="filterByPeriod(this, 'annually')">Annually</button>
        <input type="text" class="search-box" placeholder="Search requirements..." id="searchBox" onkeyup="searchRequirements()">
      </div>

      <!-- Barangay Info -->
      <div class="barangay-header">
        <h2 id="selectedBarangay">Loading...</h2>
        <span class="date" id="currentDate"></span>
      </div>

      <!-- Task Cards Container -->
      <div id="taskCardsContainer">
        <div class="loading">
          <div class="spinner"></div>
          <p>Loading your requirements...</p>
        </div>
      </div>
    </div>
  </div>

  <!-- ========== DETAIL/INPUT PAGE ========== -->
  <div class="detail-container" id="detailPage">
    <div class="detail-card">
      <!-- Header -->
      <div class="detail-header">
        <div>
          <h2 id="requirementTitle">Loading...</h2>
          <span class="date" id="detailDate"></span>
        </div>
        <button class="update-btn" onclick="saveUpdate()"> Save Update</button>
      </div>

      <!-- Description -->
      <div class="detail-description" id="requirementDescription">
        <p>Loading requirement details...</p>
      </div>

      <!-- Status Info Box -->
      <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin: 25px 0; padding: 25px; background: linear-gradient(135deg, #f9fafb 0%, #e5e7eb 100%); border-radius: 12px; border: 1px solid #d1d5db;">
        <div>
          <p style="font-size: 12px; color: #6b7280; margin-bottom: 5px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">STATUS</p>
          <p style="font-size: 16px; font-weight: 700; color: #1a202c;" id="detailStatus">-</p>
        </div>
        <div>
          <p style="font-size: 12px; color: #6b7280; margin-bottom: 5px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">DUE DATE</p>
          <p style="font-size: 16px; font-weight: 700; color: #1a202c;" id="detailDueDate">-</p>
        </div>
        <div>
          <p style="font-size: 12px; color: #6b7280; margin-bottom: 5px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">LAST UPDATE</p>
          <p style="font-size: 16px; font-weight: 700; color: #1a202c;" id="detailLastUpdate">-</p>
        </div>
      </div>

      <!-- UPLOAD SECTION 1: IMAGES -->
      <div style="margin: 25px 0; padding: 25px; background: #f9fafb; border-radius: 12px; border: 2px dashed #9ca3af;">
        <label style="display: block; margin-bottom: 12px; font-weight: 600; color: #1a202c; font-size: 16px;">
           Upload Report Images
        </label>
        <p style="font-size: 13px; color: #6b7280; margin-bottom: 15px;">
          Upload photos or screenshots of your report (PNG, JPG, GIF - Max 5MB each)
        </p>
        <input 
          type="file" 
          id="imageInput" 
          accept="image/png,image/jpeg,image/jpg,image/gif,image/webp" 
          multiple 
          onchange="handleImageSelect(event)"
          style="display: none;"
        >
        <button 
          type="button" 
          onclick="document.getElementById('imageInput').click()"
          style="padding: 12px 24px; background: #1a202c; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 600; transition: all 0.3s; display: flex; align-items: center; gap: 8px;"
          onmouseover="this.style.background='#374151'; this.style.transform='translateY(-2px)';"
          onmouseout="this.style.background='#1a202c'; this.style.transform='translateY(0)';"
        >
          <img src="{% static 'Pictures/icons/images.png' %}" alt="icon" style="width: 20px; height: 20px; object-fit: contain;">
          Choose Images
        </button>
        <span id="imageCount" style="margin-left: 15px; color: #4a5568; font-size: 14px; font-weight: 600;"></span>
      </div>

      <!-- Uploaded Images List -->
      <div id="uploadedImages" style="margin: 20px 0;"></div>

      <!-- UPLOAD SECTION 2: DOCUMENTS -->
      <div style="margin: 25px 0; padding: 25px; background: #f9fafb; border-radius: 12px; border: 2px dashed #9ca3af;">
        <label style="display: block; margin-bottom: 12px; font-weight: 600; color: #1a202c; font-size: 16px;">
           Upload Supporting Documents
        </label>
        <p style="font-size: 13px; color: #6b7280; margin-bottom: 15px;">
          Upload official documents (PDF, Word, Excel, PowerPoint - Max 10MB each)
        </p>
        <input 
          type="file" 
          id="documentInput" 
          accept=".pdf,.doc,.docx,.xls,.xlsx,.ppt,.pptx" 
          multiple 
          onchange="handleDocumentSelect(event)"
          style="display: none;"
        >
        <button 
          type="button" 
          onclick="document.getElementById('documentInput').click()"
          style="padding: 12px 24px; background: #1a202c; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 600; transition: all 0.3s; display: flex; align-items: center; gap: 8px;"
          onmouseover="this.style.background='#374151'; this.style.transform='translateY(-2px)';"
          onmouseout="this.style.background='#1a202c'; this.style.transform='translateY(0)';"
        >  
          <img src="{% static 'Pictures/icons/up-loading.png' %}" alt="icon" style="width: 18px; height: 18px; object-fit: contain;">
          Choose Documents
        </button>
        <span id="documentCount" style="margin-left: 15px; color: #4a5568; font-size: 14px; font-weight: 600;"></span>
      </div>

      <!-- Uploaded Documents List -->
      <div id="uploadedDocuments" style="margin: 20px 0;"></div>

      <!-- Action Buttons -->
      <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 30px; padding-top: 25px; border-top: 2px solid #e5e7eb;">
        <button 
          onclick="backToMonitoring()" 
          style="padding: 14px 28px; background: #6b7280; color: white; border: none; border-radius: 10px; cursor: pointer; font-weight: 600; font-size: 15px; transition: all 0.3s; box-shadow: 0 2px 8px rgba(107, 114, 128, 0.3);"
          onmouseover="this.style.background='#4b5563'; this.style.transform='translateY(-2px)';"
          onmouseout="this.style.background='#6b7280'; this.style.transform='translateY(0)';"
        >
          ‚Üê Back to List
        </button>
        <button 
          onclick="submitRequirement()" 
          style="padding: 14px 32px; background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; border: none; border-radius: 10px; cursor: pointer; font-weight: 700; font-size: 15px; transition: all 0.3s; box-shadow: 0 4px 6px rgba(16, 185, 129, 0.3);"
          onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 12px rgba(16, 185, 129, 0.4)'"
          onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 6px rgba(16, 185, 129, 0.3)'"
        >
           Submit to Admin
        </button>
      </div>
    </div>
  </div>

  <script>
    // ========== GLOBAL STATE ==========
    let currentSubmissionId = null;
    let currentPeriod = 'weekly';
    let currentWeek = 1;
    let currentSubmissionData = null;

    // ========== INITIALIZE ON PAGE LOAD ==========
    document.addEventListener('DOMContentLoaded', function() {
      updateCurrentDate();
      
      // Initialize modal event listeners
      const modal = document.getElementById('confirmModal');
      if (modal) {
        modal.addEventListener('click', function(e) {
          if (e.target === this) {
            closeModal();
          }
        });
      }
      
      // IMPORTANT: Show welcome page first on login
      document.getElementById('welcomePage').style.display = 'flex';
      document.getElementById('monitoringPage').style.display = 'none';
      document.getElementById('detailPage').style.display = 'none';
      
      // Load notifications
      loadBarangayNotifications();
      
      // Auto-refresh notifications every 30 seconds
      setInterval(() => {
        loadBarangayNotifications();
      }, 30000);
    });

    // ========== NAVIGATION FUNCTIONS ==========
    function showMonitoring() {
      document.getElementById('welcomePage').style.display = 'none';
      document.getElementById('monitoringPage').style.display = 'block';
      document.getElementById('detailPage').style.display = 'none';
      
      loadRequirements();
    }

    function showWelcome() {
      document.getElementById('welcomePage').style.display = 'flex';
      document.getElementById('monitoringPage').style.display = 'none';
      document.getElementById('detailPage').style.display = 'none';
    }

    function backToMonitoring() {
      document.getElementById('welcomePage').style.display = 'none';
      document.getElementById('monitoringPage').style.display = 'block';
      document.getElementById('detailPage').style.display = 'none';
      loadRequirements();
    }

    // ========== NOTIFICATION FUNCTIONS ==========
    function toggleNotificationDropdown(event) {
      event.stopPropagation();
      const dropdown = document.getElementById('barangayNotificationDropdown');
      if (!dropdown) return;
      
      if (dropdown.classList.contains('show')) {
        dropdown.classList.remove('show');
      } else {
        dropdown.classList.add('show');
        loadBarangayNotifications();
      }
    }

    function loadBarangayNotifications() {
      fetch('/api/notifications/', {
        method: 'GET',
        credentials: 'same-origin',
        headers: {
          'X-CSRFToken': getCookie('csrftoken'),
          'X-Requested-With': 'XMLHttpRequest'
        }
      })
      .then(response => {
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}`);
        }
        return response.json();
      })
      .then(data => {
        if (data.success) {
          renderBarangayNotifications(data.notifications);
          updateBarangayNotificationBadge(data.unread_count);
        } else {
          console.error('Failed to load notifications:', data.error);
        }
      })
      .catch(error => {
        console.error('Error loading notifications:', error);
      });
    }

    function renderBarangayNotifications(notifications) {
      const container = document.getElementById('barangayNotificationList');
      
      if (!container) return;
      
      if (notifications.length === 0) {
        container.innerHTML = `
          <div class="notification-empty">
            <div class="notification-empty-icon"></div>
            <p>No notifications yet</p>
          </div>
        `;
        return;
      }
      
      container.innerHTML = '';
      
      notifications.forEach(notif => {
        const item = document.createElement('div');
        item.className = `notification-item ${notif.is_read ? '' : 'unread'}`;
        item.setAttribute('data-id', notif.id);
        item.onclick = () => handleBarangayNotificationClick(notif);
        
        const iconClass = getNotificationIconClass(notif.type);
        const icon = getNotificationIcon(notif.type);
        
        item.innerHTML = `
          <div class="notification-icon ${iconClass}">
            ${icon}
          </div>
          <div class="notification-content">
            <div class="notification-title">${notif.title}</div>
            <div class="notification-message">${notif.message}</div>
            <div class="notification-time">${notif.time_ago}</div>
          </div>
        `;
        
        container.appendChild(item);
      });
    }

    function getNotificationIconClass(type) {
      const iconMap = {
        'overdue': 'overdue',
        'upcoming': 'upcoming',
        'completed': 'completed',
        'reminder': 'upcoming',
        'info': 'info',
        'announcement': 'info'
      };
      return iconMap[type] || 'info';
    }

    function getNotificationIcon(type) {
      const iconMap = {
        'overdue': '‚ö†Ô∏è',
        'upcoming': '‚è∞',
        'completed': '‚úÖ',
        'reminder': 'üîî',
        'info': '‚ÑπÔ∏è',
        'announcement': 'üì¢'
      };
      return iconMap[type] || 'üìå';
    }

    function handleBarangayNotificationClick(notif) {
      markBarangayNotificationAsRead(notif.id);
      
      // If notification is linked to a submission, navigate to it
      if (notif.submission_id) {
        // Close dropdown
        const dropdown = document.getElementById('barangayNotificationDropdown');
        if (dropdown) dropdown.classList.remove('show');
        
        // Navigate to monitoring page if not already there
        if (document.getElementById('monitoringPage').style.display === 'none') {
          showMonitoring();
        }
        
        // Wait for page to load, then scroll to submission
        setTimeout(() => {
          viewSubmission(notif.submission_id);
        }, 500);
      }
    }

    function markBarangayNotificationAsRead(notificationId) {
      fetch(`/api/notifications/${notificationId}/read/`, {
        method: 'POST',
        credentials: 'same-origin',
        headers: {
          'X-CSRFToken': getCookie('csrftoken'),
          'X-Requested-With': 'XMLHttpRequest',
          'Content-Type': 'application/json'
        }
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          // Update UI
          const item = document.querySelector(`.notification-item[data-id="${notificationId}"]`);
          if (item) {
            item.classList.remove('unread');
          }
          
          // Update badge
          const badge = document.getElementById('barangayNotificationBadge');
          if (badge && badge.style.display !== 'none') {
            const currentCount = parseInt(badge.textContent) || 0;
            if (currentCount > 0) {
              updateBarangayNotificationBadge(currentCount - 1);
            }
          }
        }
      })
      .catch(error => {
        console.error('Error marking notification as read:', error);
      });
    }

    function markAllBarangayNotificationsRead() {
      fetch('/api/notifications/mark-all-read/', {
        method: 'POST',
        credentials: 'same-origin',
        headers: {
          'X-CSRFToken': getCookie('csrftoken'),
          'X-Requested-With': 'XMLHttpRequest',
          'Content-Type': 'application/json'
        }
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          showToast('All notifications marked as read', 'success');
          loadBarangayNotifications();
        }
      })
      .catch(error => {
        console.error('Error marking all as read:', error);
      });
    }

    function updateBarangayNotificationBadge(count) {
      const badge = document.getElementById('barangayNotificationBadge');
      if (badge) {
        if (count > 0) {
          badge.textContent = count > 99 ? '99+' : count;
          badge.style.display = 'flex';
        } else {
          badge.style.display = 'none';
        }
      }
    }

    // Close notification dropdown when clicking outside
    document.addEventListener('click', function(e) {
      const dropdown = document.getElementById('barangayNotificationDropdown');
      const bellIcon = e.target.closest('.user-icon');
      
      if (!e.target.closest('#barangayNotificationDropdown') && 
          !(bellIcon && bellIcon.textContent.includes('üîî'))) {
        if (dropdown) {
          dropdown.classList.remove('show');
        }
      }
    });

    // ========== FILTER BY PERIOD ==========
    function filterByPeriod(element, period) {
      const tabs = document.querySelectorAll('.tab');
      tabs.forEach(tab => tab.classList.remove('active'));
      element.classList.add('active');
      
      currentPeriod = period;
      
      loadRequirements();
    }

    // ========== LOAD REQUIREMENTS (REAL API) ==========
    function loadRequirements() {
      const container = document.getElementById('taskCardsContainer');
      container.innerHTML = '<div class="loading"><div class="spinner"></div><p>Loading requirements...</p></div>';
      
      const params = new URLSearchParams({
        period: currentPeriod
      });
      
      if (currentPeriod === 'weekly') {
        params.append('week', currentWeek);
      }
      
      const searchTerm = document.getElementById('searchBox')?.value.trim();
      if (searchTerm) {
        params.append('search', searchTerm);
      }
      
      console.log(`üîç Loading: period=${currentPeriod}`);
      
      fetch(`/api/requirements/list/?${params}`, {
        method: 'GET',
        credentials: 'same-origin',
        headers: {
          'X-CSRFToken': getCookie('csrftoken'),
          'X-Requested-With': 'XMLHttpRequest'
        }
      })
      .then(response => {
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        return response.json();
      })
      .then(data => {
        console.log('‚úÖ Loaded:', data);
        if (data.success) {
          renderRequirements(data.submissions);
          if (data.barangay_name) {
            document.getElementById('selectedBarangay').textContent = data.barangay_name;
            document.getElementById('topBarangayName').textContent = data.barangay_name;
          }
        } else {
          throw new Error(data.error || 'Failed to load');
        }
      })
      .catch(error => {
        console.error('‚ùå Error:', error);
        container.innerHTML = `
          <div class="loading">
            <p style="color: #ef4444; font-weight: 600;">Error Loading Requirements</p>
            <p style="color: #6b7280; font-size: 14px; margin-top: 10px;">${error.message}</p>
            <button onclick="loadRequirements()" 
                    style="margin-top: 15px; padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">
              üîÑ Try Again
            </button>
          </div>
        `;
      });
    }

    // ========== RENDER REQUIREMENTS ==========
    function renderRequirements(submissions) {
      const container = document.getElementById('taskCardsContainer');
      
      if (!submissions || submissions.length === 0) {
        container.innerHTML = `
          <div class="loading">
            <p style="color: #6b7280;">No requirements found for this period</p>
          </div>
        `;
        return;
      }
      
      container.innerHTML = '';
      
      submissions.forEach(sub => {
        const card = document.createElement('div');
        card.className = 'task-card';
        card.setAttribute('data-name', sub.title.toLowerCase());
        
        const statusClass = sub.status.replace('_', '-');
        
        card.innerHTML = `
          <div class="task-info">
            <h3>${sub.title}</h3>
            <span class="status ${statusClass}">${sub.status_display}</span>
          </div>
          <div class="card-actions">
            <button class="view-btn" onclick="viewSubmission(${sub.id})">View Details ‚Üí</button>
          </div>
        `;
        
        container.appendChild(card);
      });
    }

    // ========== VIEW SUBMISSION DETAIL ==========
    function viewSubmission(submissionId) {
      currentSubmissionId = submissionId;
      
      document.getElementById('requirementTitle').textContent = 'Loading...';
      document.getElementById('requirementDescription').innerHTML = '<p>Loading...</p>';
      
      fetch(`/api/requirements/submission/${submissionId}/`, {
        method: 'GET',
        credentials: 'same-origin',
        headers: {
          'X-CSRFToken': getCookie('csrftoken'),
          'X-Requested-With': 'XMLHttpRequest'
        }
      })
      .then(response => {
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        return response.json();
      })
      .then(data => {
        if (data.success && data.submission) {
          const sub = data.submission;
          currentSubmissionData = sub;
          
          document.getElementById('requirementTitle').textContent = sub.title || 'Requirement Details';
          document.getElementById('requirementDescription').innerHTML = `<p>${sub.description || 'No description'}</p>`;
          document.getElementById('detailDate').textContent = new Date().toLocaleDateString();
          document.getElementById('detailStatus').textContent = sub.status_display || 'N/A';
          document.getElementById('detailDueDate').textContent = sub.due_date || 'N/A';
          document.getElementById('detailLastUpdate').textContent = sub.last_update || 'Never';
          
          document.getElementById('uploadedImages').innerHTML = '';
          document.getElementById('uploadedDocuments').innerHTML = '';
          document.getElementById('imageCount').textContent = '';
          document.getElementById('documentCount').textContent = '';
          
          if (sub.attachments && sub.attachments.length > 0) {
            sub.attachments.forEach(att => {
              const isImage = ['png', 'jpg', 'jpeg', 'gif', 'webp'].includes(
                att.file_name.split('.').pop().toLowerCase()
              );
              addFileToList(att, isImage ? 'image' : 'document');
            });
          }
          
          document.getElementById('welcomePage').style.display = 'none';
          document.getElementById('monitoringPage').style.display = 'none';
          document.getElementById('detailPage').style.display = 'block';
        } else {
          throw new Error(data.error || 'Failed to load');
        }
      })
      .catch(error => {
        console.error('‚ùå Error:', error);
        showToast('Error loading submission: ' + error.message, 'error');
      });
    }

    // ========== IMAGE UPLOAD ==========
    function handleImageSelect(event) {
      const files = event.target.files;
      if (files.length === 0) return;
      
      const allowedTypes = ['image/png', 'image/jpeg', 'image/jpg', 'image/gif', 'image/webp'];
      
      for (let file of files) {
        if (!allowedTypes.includes(file.type)) {
          showToast(`${file.name}: Only PNG, JPG, GIF, WEBP allowed`, 'error');
          event.target.value = '';
          return;
        }
        if (file.size > 5 * 1024 * 1024) {
          showToast(`${file.name} too large (max 5MB)`, 'error');
          event.target.value = '';
          return;
        }
      }
      
      const imageCount = document.getElementById('imageCount');
      imageCount.textContent = `${files.length} image(s) selected`;
      
      for (let file of files) {
        uploadFile(file, 'image');
      }
      
      setTimeout(() => {
        event.target.value = '';
        imageCount.textContent = '';
      }, 1000);
    }

    // ========== DOCUMENT UPLOAD ==========
    function handleDocumentSelect(event) {
      const files = event.target.files;
      if (files.length === 0) return;
      
      const allowedTypes = [
        'application/pdf',
        'application/msword',
        'application/vnd.openxmlformats-officedocument.wordprocessingml.document',
        'application/vnd.ms-excel',
        'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',
        'application/vnd.ms-powerpoint',
        'application/vnd.openxmlformats-officedocument.presentationml.presentation'
      ];
      
      const allowedExtensions = ['.pdf', '.doc', '.docx', '.xls', '.xlsx', '.ppt', '.pptx'];
      
      for (let file of files) {
        const fileExtension = '.' + file.name.split('.').pop().toLowerCase();
        const isValidType = allowedTypes.includes(file.type) || allowedExtensions.includes(fileExtension);
        
        if (!isValidType) {
          showToast(`${file.name}: Only PDF, Word, Excel, PowerPoint allowed`, 'error');
          event.target.value = '';
          return;
        }
        if (file.size > 10 * 1024 * 1024) {
          showToast(`${file.name} too large (max 10MB)`, 'error');
          event.target.value = '';
          return;
        }
      }
      
      const documentCount = document.getElementById('documentCount');
      documentCount.textContent = `${files.length} document(s) selected`;
      
      for (let file of files) {
        uploadFile(file, 'document');
      }
      
      setTimeout(() => {
        event.target.value = '';
        documentCount.textContent = '';
      }, 1000);
    }

    // ========== UPLOAD FILE (REAL API) ==========
    function uploadFile(file, type) {
      if (!currentSubmissionId) {
        showToast('Error: No submission selected', 'error');
        return;
      }
      
      const formData = new FormData();
      formData.append('file', file);
      formData.append('file_type', type);
      
      showToast(`Uploading ${file.name}...`, 'success');
      
      fetch(`/api/requirements/submission/${currentSubmissionId}/upload/`, {
        method: 'POST',
        credentials: 'same-origin',
        headers: {
          'X-CSRFToken': getCookie('csrftoken'),
          'X-Requested-With': 'XMLHttpRequest'
        },
        body: formData
      })
      .then(response => {
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        return response.json();
      })
      .then(data => {
        if (data.success && data.attachment) {
          showToast(`${type === 'image' ? 'Image' : 'Document'} uploaded successfully`, 'success');
          addFileToList(data.attachment, type);
        } else {
          throw new Error(data.error || 'Upload failed');
        }
      })
      .catch(error => {
        console.error('‚ùå Upload error:', error);
        showToast('Upload failed: ' + error.message, 'error');
      });
    }

    // ========== ADD FILE TO LIST ==========
    function addFileToList(attachment, type) {
      const container = document.getElementById(type === 'image' ? 'uploadedImages' : 'uploadedDocuments');
      
      if (document.querySelector(`.file-item[data-id="${attachment.id}"]`)) {
        return;
      }
      
      const fileItem = document.createElement('div');
      fileItem.className = 'file-item';
      fileItem.setAttribute('data-id', attachment.id);
      
      const fileName = attachment.file_name;
      const extension = fileName.split('.').pop().toLowerCase();
      let icon = '';
      
      if (['png', 'jpg', 'jpeg', 'gif', 'webp'].includes(extension)) icon = '';
      else if (extension === 'pdf') icon = '';
      else if (['doc', 'docx'].includes(extension)) icon = '';
      else if (['xls', 'xlsx'].includes(extension)) icon = '';
      else if (['ppt', 'pptx'].includes(extension)) icon = '';
      
      const bgColor = type === 'image' ? '#fef3c7' : '#dbeafe';
      const fileSize = attachment.file_size || 0;
      
      fileItem.innerHTML = `
        <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: ${bgColor}; border-radius: 8px; margin-bottom: 8px;">
          <span style="font-size: 14px; color: #1a202c;">
            ${icon} ${fileName} <span style="color: #6b7280;">(${fileSize} KB)</span>
          </span>
          <button 
            onclick="removeAttachment(${attachment.id})" 
            style="background: #ef4444; color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 600;"
            onmouseover="this.style.background='#dc2626'"
            onmouseout="this.style.background='#ef4444'"
          >
            Remove
          </button>
        </div>
      `;
      
      container.appendChild(fileItem);
    }

    // ========== REMOVE ATTACHMENT ==========
    function removeAttachment(attachmentId) {
      showConfirmModal(
        'Remove File',
        'Are you sure you want to remove this file?',
        function() {
          if (!currentSubmissionId) {
            showToast('Error: No submission selected', 'error');
            return;
          }
          
          fetch(`/api/requirements/attachment/${attachmentId}/delete/`, {
            method: 'POST',
            credentials: 'same-origin',
            headers: {
              'X-CSRFToken': getCookie('csrftoken'),
              'X-Requested-With': 'XMLHttpRequest',
              'Content-Type': 'application/json'
            }
          })
          .then(response => {
            if (!response.ok) throw new Error(`HTTP ${response.status}`);
            return response.json();
          })
          .then(data => {
            if (data.success) {
              showToast('File removed successfully', 'success');
              const fileItem = document.querySelector(`.file-item[data-id="${attachmentId}"]`);
              if (fileItem) fileItem.remove();
            } else {
              throw new Error(data.error || 'Failed to remove');
            }
          })
          .catch(error => {
            console.error('‚ùå Error:', error);
            showToast('Error: ' + error.message, 'error');
          });
        }
      );
    }

    // ========== SAVE UPDATE ==========
    function saveUpdate() {
      showToast('Files are automatically saved when uploaded', 'success');
    }

    // ========== SUBMIT TO ADMIN (WITH DEBUG LOGGING) ==========
function submitRequirement() {
  const imageCount = document.getElementById('uploadedImages').children.length;
  const docCount = document.getElementById('uploadedDocuments').children.length;

  if (imageCount === 0 && docCount === 0) {
    showToast('Please upload at least one file before submitting', 'error');
    return;
  }
  
  if (!currentSubmissionId) {
    showToast('Error: No submission selected', 'error');
    return;
  }
  
  showConfirmModal(
    'Submit Requirement',
    'Are you sure you want to submit this requirement to the admin? This will mark it as accomplished and notify the admin for review.',
    function() {
      console.log('\n' + '='.repeat(60));
      console.log('üöÄ SUBMITTING REQUIREMENT');
      console.log('='.repeat(60));
      console.log('Submission ID:', currentSubmissionId);
      console.log('URL:', `/api/requirements/submission/${currentSubmissionId}/submit/`);
      
      const submitBtns = document.querySelectorAll('button');
      let submitBtn = null;
      submitBtns.forEach(btn => {
        if (btn.textContent.includes('Submit to Admin')) {
          submitBtn = btn;
        }
      });
      
      if (submitBtn) {
        submitBtn.disabled = true;
        submitBtn.textContent = '‚è≥ Submitting...';
      }
      
      fetch(`/api/requirements/submission/${currentSubmissionId}/submit/`, {
        method: 'POST',
        credentials: 'same-origin',
        headers: {
          'X-CSRFToken': getCookie('csrftoken'),
          'X-Requested-With': 'XMLHttpRequest',
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          update_text: currentSubmissionData?.update_text || 'Submitted for review'
        })
      })
      .then(response => {
        console.log('üì• Response received:');
        console.log('   Status:', response.status);
        console.log('   OK:', response.ok);
        
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        return response.json();
      })
      .then(data => {
        console.log('üì¶ Response data:');
        console.log(data);
        console.log('   success:', data.success);
        console.log('   message:', data.message);
        
        // ‚úÖ CHECK FOR DEBUG INFO
        if (data.debug) {
          console.log('üîç Debug info:');
          console.log('   Admins found:', data.debug.admins_found);
          console.log('   Notifications created:', data.debug.notifications_created || data.notifications_created);
          console.log('   Submission status:', data.debug.submission_status);
        } else {
          console.warn('‚ö†Ô∏è No debug info in response!');
        }
        
        console.log('='.repeat(60) + '\n');
        
        if (data.success) {
          showToast('‚úÖ Successfully submitted to admin! Waiting for approval.', 'success');
          setTimeout(() => backToMonitoring(), 1500);
        } else {
          throw new Error(data.error || 'Submission failed');
        }
      })
      .catch(error => {
        console.error('‚ùå SUBMISSION ERROR:');
        console.error(error);
        console.log('='.repeat(60) + '\n');
        
        showToast('‚ùå Submission failed: ' + error.message, 'error');
        if (submitBtn) {
          submitBtn.disabled = false;
          submitBtn.textContent = '‚úÖ Submit to Admin';
        }
      });
    }
  );
}

    // ========== SEARCH REQUIREMENTS ==========
    function searchRequirements() {
      const searchTerm = document.getElementById('searchBox').value.toLowerCase();
      const cards = document.querySelectorAll('.task-card');
      
      cards.forEach(card => {
        const name = card.getAttribute('data-name');
        card.style.display = name.includes(searchTerm) ? 'flex' : 'none';
      });
    }

    // ========== USER DROPDOWN ==========
    function toggleUserDropdown() {
      const dropdown = document.getElementById('userDropdown');
      dropdown.classList.toggle('show');
      
      document.addEventListener('click', function closeUserDropdown(e) {
        if (!e.target.closest('.user-icon')) {
          dropdown.classList.remove('show');
          document.removeEventListener('click', closeUserDropdown);
        }
      });
    }

    //  NEW PROFILE FUNCTION (replaces the old one)
    function viewProfile() {
      // Open profile modal
      const profileModal = document.getElementById('profileModal');
      profileModal.classList.add('show');
      
      // Fetch user profile data
      fetch('/api/user/profile/', {
        method: 'GET',
        credentials: 'same-origin',
        headers: {
          'X-CSRFToken': getCookie('csrftoken'),
          'X-Requested-With': 'XMLHttpRequest'
        }
      })
      .then(response => {
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        return response.json();
      })
      .then(data => {
        if (data.success && data.profile) {
          const profile = data.profile;
          
          // Update profile modal with user data
          document.getElementById('profileName').textContent = profile.full_name || profile.username || 'User';
          document.getElementById('profileEmail').textContent = profile.email || 'Not provided';
          document.getElementById('profileBarangay').textContent = profile.barangay_name || 'N/A';
          document.getElementById('profileUsername').textContent = profile.username || 'N/A';
          document.getElementById('profileRole').textContent = profile.role_display || 'Barangay User';
          document.getElementById('profileJoined').textContent = profile.date_joined || 'N/A';
          
          // Update avatar with first letter of name
          const firstLetter = (profile.full_name || profile.username || 'U').charAt(0).toUpperCase();
          document.getElementById('profileAvatar').textContent = firstLetter;
        } else {
          throw new Error(data.error || 'Failed to load profile');
        }
      })
      .catch(error => {
        console.error('‚ùå Error loading profile:', error);
        showToast('Error loading profile: ' + error.message, 'error');
        
        // Show placeholder data on error
        document.getElementById('profileName').textContent = 'User Profile';
        document.getElementById('profileEmail').textContent = 'Error loading data';
        document.getElementById('profileBarangay').textContent = '-';
        document.getElementById('profileUsername').textContent = '-';
        document.getElementById('profileJoined').textContent = '-';
      });
    }

    // üëá NEW FUNCTION to close profile modal
    function closeProfileModal() {
      const profileModal = document.getElementById('profileModal');
      if (profileModal) {
        profileModal.classList.remove('show');
      }
      showToast('Profile feature coming soon', 'success');
    }
    function viewSettings() {
      showToast('Settings feature coming soon', 'success');

    }

    // Close profile modal when clicking outside
    document.addEventListener('click', function(e) {
      const profileModal = document.getElementById('profileModal');
      if (e.target === profileModal) {
        closeProfileModal();
      }
    });
    
    function viewSettings() {
      // Open settings modal
      const settingsModal = document.getElementById('settingsModal');
      if (!settingsModal) {
        console.error('‚ùå Settings modal not found in DOM');
        showToast('Settings feature not available', 'error');
        return;
      }
      
      settingsModal.classList.add('show');
      
      // Load current user settings
      loadUserSettings();
    }

    function loadUserSettings() {
      // Fetch user settings from backend
      fetch('/api/user/settings/', {
        method: 'GET',
        credentials: 'same-origin',
        headers: {
          'X-CSRFToken': getCookie('csrftoken'),
          'X-Requested-With': 'XMLHttpRequest'
        }
      })
      .then(response => {
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        return response.json();
      })
      .then(data => {
        if (data.success && data.settings) {
          const settings = data.settings;
          
          // Populate form fields
          document.getElementById('settingsEmail').value = settings.email || '';
          
          // Set toggle switches based on saved preferences
          if (settings.email_notifications) {
            document.getElementById('toggleEmailNotif').classList.add('active');
          }
          if (settings.deadline_reminders !== false) {
            document.getElementById('toggleDeadlineReminder').classList.add('active');
          }
          if (settings.announcements !== false) {
            document.getElementById('toggleAnnouncements').classList.add('active');
          }
          if (settings.compact_view) {
            document.getElementById('toggleCompactView').classList.add('active');
          }
        }
      })
      .catch(error => {
        console.error('‚ùå Error loading settings:', error);
        // Still show modal with default values
      });
    }

    function toggleSetting(element) {
      // Ignore dark mode toggle (coming soon)
      if (element.id === 'toggleDarkMode') {
        showToast('Dark mode coming soon!', 'success');
        return;
      }
      
      element.classList.toggle('active');
    }

    function saveSettings() {
      const currentPassword = document.getElementById('settingsCurrentPassword').value;
      const newPassword = document.getElementById('settingsNewPassword').value;
      const confirmPassword = document.getElementById('settingsConfirmPassword').value;
      
      // Validate passwords if trying to change
      if (newPassword || confirmPassword) {
        if (!currentPassword) {
          showToast('Please enter your current password', 'error');
          return;
        }
        if (newPassword !== confirmPassword) {
          showToast('New passwords do not match', 'error');
          return;
        }
        if (newPassword.length < 8) {
          showToast('Password must be at least 8 characters', 'error');
          return;
        }
      }
      
      // Collect settings data
      const settingsData = {
        email: document.getElementById('settingsEmail').value,
        email_notifications: document.getElementById('toggleEmailNotif').classList.contains('active'),
        deadline_reminders: document.getElementById('toggleDeadlineReminder').classList.contains('active'),
        announcements: document.getElementById('toggleAnnouncements').classList.contains('active'),
        compact_view: document.getElementById('toggleCompactView').classList.contains('active'),
      };
      
      // Add password fields if changing password
      if (currentPassword && newPassword) {
        settingsData.current_password = currentPassword;
        settingsData.new_password = newPassword;
      }
      
      // Save to backend
      fetch('/api/user/settings/', {
        method: 'POST',
        credentials: 'same-origin',
        headers: {
          'X-CSRFToken': getCookie('csrftoken'),
          'X-Requested-With': 'XMLHttpRequest',
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(settingsData)
      })
      .then(response => {
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        return response.json();
      })
      .then(data => {
        if (data.success) {
          showToast('‚úÖ Settings saved successfully!', 'success');
          
          // Clear password fields
          document.getElementById('settingsCurrentPassword').value = '';
          document.getElementById('settingsNewPassword').value = '';
          document.getElementById('settingsConfirmPassword').value = '';
          
          // Close modal after short delay
          setTimeout(() => {
            closeSettingsModal();
          }, 1500);
        } else {
          throw new Error(data.error || 'Failed to save settings');
        }
      })
      .catch(error => {
        console.error('‚ùå Error saving settings:', error);
        showToast('Error: ' + error.message, 'error');
      });
    }

    function closeSettingsModal() {
      const settingsModal = document.getElementById('settingsModal');
      if (settingsModal) {
        settingsModal.classList.remove('show');
      }
    }

    // Close settings modal when clicking outside
    document.addEventListener('click', function(e) {
      const settingsModal = document.getElementById('settingsModal');
      if (e.target === settingsModal) {
        closeSettingsModal();
      }
    });

    function logout() {
      console.log('üîµ Logout clicked');
      showConfirmModal(
        'Confirm Logout',
        'Are you sure you want to logout from the system?',
        function() {
          console.log('üîµ Logout confirmed');
          showToast('Logging out...', 'success');
          
          fetch('/logout/', {
            method: 'POST',
            credentials: 'same-origin',
            headers: {
              'X-CSRFToken': getCookie('csrftoken'),
              'X-Requested-With': 'XMLHttpRequest',
              'Content-Type': 'application/json'
            }
          })
          .then(response => {
            console.log('üîµ Logout response:', response);
            if (response.ok || response.redirected) {
              window.location.href = '/login/';
            } else {
              throw new Error('Logout failed');
            }
          })
          .catch(error => {
            console.error('‚ùå Logout error:', error);
            window.location.href = '/login/';
          });
        }
      );
    }

    // ========== PROFESSIONAL MODAL SYSTEM ==========
    let currentModalCallback = null;

    function showConfirmModal(title, message, onConfirm) {
      console.log('üîµ Modal opened:', title);
      document.getElementById('modalTitle').textContent = title;
      document.getElementById('modalMessage').textContent = message;
      currentModalCallback = onConfirm;
      
      const modal = document.getElementById('confirmModal');
      modal.classList.add('show');
      
      const confirmBtn = document.getElementById('modalConfirmBtn');
      confirmBtn.onclick = function() {
        console.log('üîµ Modal OK clicked');
        
        const callback = currentModalCallback;
        
        closeModal();
        
        if (callback) {
          try {
            console.log('üîµ Executing callback...');
            callback();
          } catch (error) {
            console.error('‚ùå Modal callback error:', error);
            showToast('An error occurred', 'error');
          }
        } else {
          console.log('‚ö†Ô∏è No callback found');
        }
      };
    }

    function closeModal() {
      console.log('üîµ Modal closed');
      const modal = document.getElementById('confirmModal');
      if (modal) {
        modal.classList.remove('show');
      }
      currentModalCallback = null;
    }

    // ========== UTILITY FUNCTIONS ==========
    function updateCurrentDate() {
      const dateElement = document.getElementById('currentDate');
      if (dateElement) {
        const today = new Date();
        const options = { year: 'numeric', month: 'long', day: 'numeric' };
        dateElement.textContent = today.toLocaleDateString('en-US', options);
      }
    }

    function showToast(message, type = 'success') {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.className = `toast ${type} show`;
      setTimeout(() => toast.classList.remove('show'), 3000);
    }

    function getCookie(name) {
      let cookieValue = null;
      if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
          const cookie = cookies[i].trim();
          if (cookie.substring(0, name.length + 1) === (name + '=')) {
            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
            break;
          }
        }
      }
      return cookieValue;
    }
  </script>

</body>
</html>